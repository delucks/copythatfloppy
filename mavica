#!/usr/bin/env python3
# the "mavica" script copies all the photos off a Mavica camera, elegantly
#
# version 0.1: shell script translated to python: mounts/unmounts a block device and copies pictures to the current directory
# TODO:
# - Prompt for the current date and format each of the JPGs with a new filename that's "2024-08-21_f1_MVC-009F.JPG"
# - Take parameters, add a parameter for a middle-string (like "floppy1" or "f1")
# - Draw certain things from the environment (like the block device, mountpoint, target dir, middle-string)
# - Add standard JPG metadata into these files based on the current datetime

import subprocess
import glob
import os
import shutil
import shlex
import argparse
from contextlib import contextmanager

def run(command: str, dry_run: bool = False):
    '''run a string command through subprocess, echo'ing the command to be executed when dry_run = True'''
    command_fragments = shlex.split(command)
    if dry_run:
        command_fragments.insert(0, 'echo')
    return subprocess.run(command_fragments)

def copy_files_from(source_dir: str, dest_dir: str, dry_run: bool = False):
    '''copy all the files from source_dir to dest_dir, or echo the files to be copied when dry_run = True'''
    files = glob.iglob(os.path.join(source_dir, "*.JPG"))
    for file in files:
        if os.path.isfile(file):
            if dry_run:
                print(f'would copy {file} to {dest_dir}')
            else:
                shutil.copy2(file, dest_dir)

@contextmanager
def mounted_block_device(drive: str, mountpoint: str, dry_run: bool):
    # string interpolating into a root-level command because it's fun to enjoy life
    try:
        run(f'sudo mount {drive} {mountpoint}', dry_run)
        yield
    finally:
        run(f'sudo umount {mountpoint}', dry_run)

def main():
    p = argparse.ArgumentParser('copy your crunchy JPGs from a Mavica floppy disk')
    p.add_argument('drive', default='/dev/sdc', help='path to the block device for the floppy drive')
    p.add_argument('--destination', default='.', help='the directory where your JPGs should end up')
    p.add_argument('--mountpoint', default='/mnt/tmp', help='path to the mountpoint where the floppies should be mounted')
    p.add_argument('--dry-run', action='store_true', default=False, help='write what actions will be performed to stdout')
    args = p.parse_args()
    with mounted_block_device(args.drive, args.mountpoint, args.dry_run):
        copy_files_from(args.mountpoint, args.destination, args.dry_run)

if __name__ == '__main__':
    main()
